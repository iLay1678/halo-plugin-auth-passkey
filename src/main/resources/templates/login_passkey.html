<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>
    <body>
        <div th:fragment="form">
            <style>
                button[type="submit"] {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 6px;
                }
            </style>

            <div id="passkey-error" class="alert alert-error" role="alert" style="display: none"></div>
            <div id="passkey-warn" class="alert" role="alert" style="display: none">您的浏览器不支持通行密钥</div>

            <script th:inline="javascript">
                (function () {
                    var API = "/apis/api.passkey.halo.run/v1alpha1";
                    var errDiv = document.getElementById("passkey-error");
                    var warnDiv = document.getElementById("passkey-warn");
                    var origin = window.location.origin;

                    // 等待 DOM 加载完成
                    if (document.readyState === "loading") {
                        document.addEventListener("DOMContentLoaded", init);
                    } else {
                        init();
                    }

                    function init() {
                        // 查找登录表单的提交按钮
                        var submitBtn = document.querySelector('.halo-form button[type="submit"]');
                        if (!submitBtn) return;

                        // 检查浏览器是否支持 WebAuthn
                        if (!window.PublicKeyCredential) {
                            warnDiv.style.display = "block";
                            submitBtn.disabled = true;
                            submitBtn.style.opacity = "0.5";
                            return;
                        }

                        // 修改按钮文字，保持原有样式
                        submitBtn.innerHTML =
                            '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M5 20q-.825 0-1.412-.587T3 18v-.8q0-.85.438-1.562T4.6 14.55q1.55-.775 3.15-1.162T11 13q.35 0 .7.013t.7.062q.275.025.437.213t.163.462q.05 1.175.575 2.213t1.4 1.762q.175.125.275.313t.1.412V19q0 .425-.288.713T14.35 20zm6-8q-1.65 0-2.825-1.175T7 8t1.175-2.825T11 4t2.825 1.175T15 8t-1.175 2.825T11 12m7.5 2q.425 0 .713-.288T19.5 13t-.288-.712T18.5 12t-.712.288T17.5 13t.288.713t.712.287m.15 8.65l-1-1q-.05-.05-.15-.35v-4.45q-1.1-.325-1.8-1.237T15 13.5q0-1.45 1.025-2.475T18.5 10t2.475 1.025T22 13.5q0 1.125-.638 2t-1.612 1.25l.9.9q.15.15.15.35t-.15.35l-.8.8q-.15.15-.15.35t.15.35l.8.8q.15.15.15.35t-.15.35l-1.3 1.3q-.15.15-.35.15t-.35-.15"/></svg><span>使用通行密钥登录</span>';

                        // 保持 type="submit" 以维持样式，但阻止默认表单提交行为
                        submitBtn.addEventListener("click", function (e) {
                            e.preventDefault();
                            handlePasskeyLogin(e);
                        });
                    }

                    function b64e(buf) {
                        var bytes = new Uint8Array(buf);
                        var s = "";
                        for (var i = 0; i < bytes.length; i++) s += String.fromCharCode(bytes[i]);
                        return btoa(s).replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
                    }

                    function b64d(str) {
                        var b = str.replace(/-/g, "+").replace(/_/g, "/");
                        b = b + "=".repeat((4 - (b.length % 4)) % 4);
                        var bin = atob(b);
                        var bytes = new Uint8Array(bin.length);
                        for (var i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                        return bytes.buffer;
                    }

                    function showErr(msg) {
                        errDiv.textContent = msg;
                        errDiv.style.display = "block";
                    }

                    async function handlePasskeyLogin(e) {
                        e.preventDefault();
                        errDiv.style.display = "none";

                        var submitBtn = e.target.closest("button");
                        submitBtn.disabled = true;
                        var originalHTML = submitBtn.innerHTML;
                        submitBtn.innerHTML = "<span>正在验证...</span>";

                        try {
                            var res1 = await fetch(API + "/authentication/options", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ origin: origin }),
                                credentials: "include",
                            });
                            if (!res1.ok) {
                                var err = await res1.json().catch(function () {
                                    return {};
                                });
                                throw new Error(err.message || "无法获取认证选项");
                            }
                            var opts = await res1.json();

                            var cred = await navigator.credentials.get({
                                publicKey: {
                                    challenge: b64d(opts.challenge),
                                    rpId: opts.rpId,
                                    timeout: opts.timeout,
                                    userVerification: opts.userVerification,
                                    allowCredentials:
                                        opts.allowCredentials && opts.allowCredentials.length > 0
                                            ? opts.allowCredentials.map(function (id) {
                                                  return { type: "public-key", id: b64d(id) };
                                              })
                                            : undefined,
                                },
                            });

                            if (!cred) throw new Error("认证已取消");

                            // 构建验证 URL，包含 remember-me 参数
                            var verifyUrl = API + "/authentication/verify";
                            var rememberMe = document.getElementById("remember-me");
                            if (rememberMe && rememberMe.checked) {
                                verifyUrl += "?remember-me=true";
                            }

                            var res2 = await fetch(verifyUrl, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    origin: origin,
                                    sessionId: opts.sessionId,
                                    credentialId: b64e(cred.rawId),
                                    authenticatorData: b64e(cred.response.authenticatorData),
                                    clientDataJSON: b64e(cred.response.clientDataJSON),
                                    signature: b64e(cred.response.signature),
                                    userHandle: cred.response.userHandle ? b64e(cred.response.userHandle) : null,
                                }),
                                credentials: "include",
                            });

                            if (!res2.ok) {
                                var e = await res2.json().catch(function () {
                                    return {};
                                });
                                throw new Error(e.message || "认证失败");
                            }

                            var params = new URLSearchParams(window.location.search);
                            var redirectUri = params.get("redirect_uri") || "/uc";

                            window.location.href = redirectUri;
                        } catch (e) {
                            if (e.name === "NotAllowedError") showErr("认证已取消或被拒绝");
                            else if (e.name === "AbortError") showErr("操作已取消");
                            else if (e.name === "TimeoutError" || (e.message && e.message.includes("timed out")))
                                showErr("操作超时，请重试");
                            else showErr(e.message || "认证失败");
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalHTML;
                        }
                    }
                })();
            </script>
        </div>
    </body>
</html>
